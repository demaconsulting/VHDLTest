---
# Reusable workflow for building VHDLTest artifacts
# This workflow is called by other workflows to build the project
on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
    secrets:
      SONAR_TOKEN:
        required: true


jobs:
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Spell Check
        uses: streetsidesoftware/cspell-action@v8
        with:
          config: .cspell.json
          files: |
            **/*.md
            **/*.cs
            **/*.yaml
            **/*.yml

      - name: Markdown Lint
        uses: DavidAnson/markdownlint-cli2-action@v22
        with:
          config: .markdownlint.json
          globs: '**/*.md'

      - name: YAML Lint
        uses: ibiqlik/action-yamllint@v3
        with:
          config_file: .yamllint.yaml

  build:
    # Permissions for this job
    permissions:
      contents: read        # To read repository contents
      pull-requests: write  # To write pull requests analysis

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.x
            9.x
            10.x

      - uses: msys2/setup-msys2@v2
        if: matrix.os == 'windows-latest'
        with:
          msystem: MINGW64
          update: true

      - uses: nickg/setup-nvc-ci@v1
        with:
          version: latest

      - name: Restore Tools
        run: >
          dotnet tool restore

      - name: Restore Dependencies
        run: >
          dotnet restore

      - name: Start Sonar Scanner
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: >
          dotnet dotnet-sonarscanner
          begin
          /k:"demaconsulting_VHDLTest"
          /o:"demaconsulting"
          /d:sonar.token="${{ secrets.SONAR_TOKEN }}"
          /d:sonar.host.url="https://sonarcloud.io"
          /d:sonar.cs.opencover.reportsPaths=**/*.opencover.xml
          /d:sonar.scanner.scanAll=false

      - name: Build
        run: >
          dotnet build
          --no-restore
          --configuration Release
          --property:Version=${{ inputs.version }}

      - name: Test
        run: >
          dotnet test
          --no-build
          --configuration Release
          --property:Version=${{ inputs.version }}
          --collect "XPlat Code Coverage;Format=opencover"
          --logger "trx;LogFileName=TestResults-${{ matrix.os }}.trx"
          --results-directory test-results

      - name: End Sonar Scanner
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: >
          dotnet dotnet-sonarscanner
          end
          /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

      - name: Generate Tool SBOM
        run: >
          dotnet sbom-tool generate
          -b src/DEMAConsulting.VHDLTest/bin/Release
          -bc src/DEMAConsulting.VHDLTest
          -pn DemaConsulting.VHDLTest
          -pv ${{ inputs.version }}
          -ps DEMAConsulting
          -nsb https://DemaConsulting.com/VHDLTest
          -pm true
          -li true

      - name: Run SBOM Workflow
        run: >
          dotnet spdx-tool
          run-workflow
          spdx-workflow.yaml

      - name: Create Dotnet Tool
        run: >
          dotnet pack
          --no-build
          --no-restore
          --property:PackageVersion=${{ inputs.version }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: artifacts-${{ matrix.os }}
          path: |
            **/*.nupkg
            **/*.snupkg
            **/manifest.spdx.json
            **/manifest.spdx.json.sha256
            *summary.md

      - name: Upload Test Results
        uses: actions/upload-artifact@v6
        with:
          name: test-results-${{ matrix.os }}
          path: test-results/**/*.trx

  test-ghdl:
    name: Test on GHDL
    # Permissions for this job
    permissions:
      contents: read  # To read repository contents

    needs: build

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        dotnet: [8.x, 9.x, 10.x]

    runs-on: ${{ matrix.os }}

    steps:

      - uses: actions/checkout@v6

      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ matrix.dotnet }}

      - uses: msys2/setup-msys2@v2
        if: matrix.os == 'windows-latest'
        with:
          msystem: MINGW64
          update: true

      - uses: ghdl/setup-ghdl@v1
        with:
          version: nightly
          backend: mcode

      - name: Download Artifacts
        uses: actions/download-artifact@v7
        with:
          name: artifacts-ubuntu-latest
          path: artifacts

      - name: Install VHDLTest
        shell: bash
        run: >
          dotnet tool install
          --global DemaConsulting.VHDLTest
          --add-source artifacts/src/DEMAConsulting.VHDLTest/bin/Release
          --version ${{ inputs.version }}

      - name: Validate VHDLTest
        shell: bash
        run: >
          # Run the validation
          vhdltest --validate --simulator ghdl
          --results ghdl-${{ matrix.os }}-${{ matrix.dotnet }}-validation.trx

      - name: Run
        working-directory: test/example
        shell: bash
        run: |
          # Run the test
          bash ./test.sh ghdl

      - name: Upload Test Results
        uses: actions/upload-artifact@v6
        with:
          name: test-results-ghdl-${{ matrix.os }}-${{ matrix.dotnet }}
          path: "*.trx"

  test-nvc:
    name: Test on NVC
    # Permissions for this job
    permissions:
      contents: read  # To read repository contents

    needs: build

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        dotnet: [8.x, 9.x, 10.x]

    runs-on: ${{ matrix.os }}

    steps:

      - uses: actions/checkout@v6

      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ matrix.dotnet }}

      - uses: msys2/setup-msys2@v2
        if: matrix.os == 'windows-latest'
        with:
          msystem: MINGW64
          update: true

      - uses: nickg/setup-nvc-ci@v1
        with:
          version: latest

      - name: Download Artifacts
        uses: actions/download-artifact@v7
        with:
          name: artifacts-ubuntu-latest
          path: artifacts

      - name: Install VHDLTest
        shell: bash
        run: >
          dotnet tool install
          --global DemaConsulting.VHDLTest
          --add-source artifacts/src/DEMAConsulting.VHDLTest/bin/Release
          --version ${{ inputs.version }}

      - name: Validate VHDLTest
        shell: bash
        run: >
          vhdltest --validate --simulator nvc
          --results nvc-${{ matrix.os }}-${{ matrix.dotnet }}-validation.trx

      - name: Run
        working-directory: test/example
        shell: bash
        run: |
          # Run the test
          bash ./test.sh nvc

      - name: Upload Test Results
        uses: actions/upload-artifact@v6
        with:
          name: test-results-nvc-${{ matrix.os }}-${{ matrix.dotnet }}
          path: "*.trx"

  build-docs:
    name: Build Documents
    runs-on: windows-latest

    needs: [build, test-ghdl, test-nvc]

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.x'

      - name: Restore Tools
        run: dotnet tool restore

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install npm dependencies
        run: npm install

      - name: Download All Test Results
        uses: actions/download-artifact@v7
        with:
          pattern: test-results-*
          path: test-results
          merge-multiple: true

      - name: Generate Requirements and Trace Matrix with ReqStream
        run: >
          dotnet reqstream
          --requirements requirements.yaml
          --tests "test-results/**/*.trx"
          --report requirements.md
          --matrix tracematrix.md
          --enforce

      - name: Build Requirements PDF with Pandoc
        run: >
          dotnet pandoc
          --defaults docs/requirements/definition.yaml
          --filter node_modules/.bin/mermaid-filter.cmd
          --output docs/requirements/requirements.html

      - name: Convert Requirements HTML to PDF with Weasyprint
        run: >
          dotnet weasyprint
          docs/requirements/requirements.html
          "docs/VHDLTest Requirements.pdf"

      - name: Build Trace Matrix PDF with Pandoc
        run: >
          dotnet pandoc
          --defaults docs/tracematrix/definition.yaml
          --filter node_modules/.bin/mermaid-filter.cmd
          --output docs/tracematrix/tracematrix.html

      - name: Convert Trace Matrix HTML to PDF with Weasyprint
        run: >
          dotnet weasyprint
          docs/tracematrix/tracematrix.html
          "docs/VHDLTest Trace Matrix.pdf"

      - name: Build PDF with Pandoc
        run: >
          dotnet pandoc
          --defaults docs/guide/definition.yaml
          --filter node_modules/.bin/mermaid-filter.cmd
          --output docs/guide/guide.html

      - name: Convert HTML to PDF with Weasyprint
        run: >
          dotnet weasyprint
          docs/guide/guide.html
          "docs/VHDLTest User Guide.pdf"

      - name: Upload Document Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: documents
          path: docs/*.pdf
